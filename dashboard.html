<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>R.Good Service — พอร์ทัลลูกค้า</title>
<meta content="ศูนย์เอกสารและติดตามสถานะแบบเรียลไทม์ — โทนมืด" name="description"/>
<style>
  :root {
    --bg: #0f172a;
    --card: rgba(30, 41, 59, 0.8);
    --card-hover: rgba(51, 65, 85, 0.9);
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --border: rgba(148, 163, 184, 0.2);
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --radius: 16px;
    --shadow: rgba(0, 0, 0, 0.3);
    --glass-border: rgba(255, 255, 255, 0.1);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    background:
      radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.15), transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.1), transparent 50%),
      linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
  }
  .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
  header {
    display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 20px;
    background: var(--card); border: 1px solid var(--glass-border); border-radius: 20px; backdrop-filter: blur(16px);
    box-shadow: 0 8px 32px var(--shadow);
  }
  .logo {
    width: 48px; height: 48px; border-radius: 12px;
    background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
    display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; color: white;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
  }
  .header-content h1 {
    font-size: 22px; font-weight: 600;
    background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .header-status { display: flex; align-items: center; gap: 8px; margin-top: 4px; color: var(--text-muted); font-size: 14px; }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.5;} }
  .header-actions { margin-left: auto; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .last-update { color: var(--text-muted); font-size: 13px; }
  .btn {
    display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border: 1px solid var(--border);
    border-radius: 12px; background: var(--card); color: var(--text); font-weight: 500; cursor: pointer;
    transition: all .2s ease; text-decoration: none; backdrop-filter: blur(8px); box-shadow: 0 4px 16px rgba(0,0,0,.2); font-size: 14px;
  }
  .btn:hover { background: var(--card-hover); border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(59,130,246,.3); }
  .btn.primary { background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); border-color: transparent; color: white; font-weight: 600; }
  .btn.primary:hover { background: linear-gradient(135deg, var(--accent-hover) 0%, #7c3aed 100%); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(59,130,246,.4); }
  .btn.ghost { background: transparent; border-color: var(--border); box-shadow: none; }
  .btn.ghost:hover { background: var(--card); }
  .btn.tiny { padding: 6px 10px; font-size: 12px; border-radius: 10px; }
  .card { background: var(--card); border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 20px; backdrop-filter: blur(16px); box-shadow: 0 8px 32px var(--shadow); transition: all .2s ease; }
  .card:hover { background: var(--card-hover); box-shadow: 0 12px 40px var(--shadow); }
  .tabs, nav.tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 24px; }
  .tab, .tabs a { padding: 12px 20px; border-radius: 50px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; transition: all .2s ease; font-weight: 500; font-size: 14px; text-decoration: none; }
  .tab.active, .tabs a.active { background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); border-color: transparent; color: white; box-shadow: 0 4px 16px rgba(59,130,246,.3); }
  .tab:hover:not(.active), .tabs a:hover:not(.active) { background: var(--card); border-color: var(--accent); }
  .hidden { display: none !important; }
  /* Layouts reused */
  .case-overview { display: grid; grid-template-columns: 1fr 300px; gap: 20px; margin-bottom: 20px; }
  @media (max-width: 768px) { .case-overview { grid-template-columns: 1fr; } }
  .main-case-info { background: var(--card); border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 24px; backdrop-filter: blur(16px); box-shadow: 0 8px 32px var(--shadow); }
  .case-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .case-title { font-size: 18px; font-weight: 600; color: var(--text); }
  .case-pills { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
  .case-pill { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); border-radius: 50px; padding: 6px 12px; font-size: 13px; color: var(--accent); font-weight: 500; }
  .product-info { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0 8px; }
  .info-tile { border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; background: rgba(148,163,184,0.06); backdrop-filter: blur(6px); }
  .info-label { display: block; font-size: 12px; letter-spacing: .3px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
  .info-value { font-weight: 600; color: var(--text); word-break: break-word; }
  @media (max-width: 768px) { .product-info { grid-template-columns: 1fr; } }
  .progress-container { margin: 20px 0; }
  .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 8px; }
  .progress-group { display: flex; align-items: center; gap: 8px; }
  .progress-label { font-weight: 500; color: var(--text); }
  .progress-percentage { font-weight: 700; font-size: 16px; color: var(--accent); }
  .progress-bar { height: 12px; background: rgba(148,163,184,0.1); border: 1px solid var(--border); border-radius: 50px; overflow: hidden; position: relative; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent) 0%, #10b981 100%); border-radius: 50px; transition: width .6s ease; position: relative; }
  .progress-fill::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
  @keyframes shimmer { 0%{transform:translateX(-100%);} 100%{transform:translateX(100%);} }
  .stepper-container { margin: 24px 0; }
  .stepper { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
  .step { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px 8px; text-align: center; transition: all .3s ease; backdrop-filter: blur(8px); }
  .step.completed { background: rgba(16,185,129,0.1); border-color: rgba(16,185,129,0.3); }
  .step.active { background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.3); box-shadow: 0 0 20px rgba(59,130,246,0.2); }
  .step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); margin: 0 auto 8px; transition: all .3s ease; }
  .step.completed .step-dot { background: var(--success); }
  .step.active .step-dot { background: var(--accent); animation: pulse-dot 2s infinite; }
  @keyframes pulse-dot { 0%,100%{transform:scale(1);} 50%{transform:scale(1.2);} }
  .step-label { font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--text); line-height: 1.3; }
  .step.completed .step-label { color: var(--success); }
  .step.active .step-label { color: var(--accent); }
  .step-date { font-size: 9px; color: var(--text-muted); line-height: 1.2; }
  .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
  .section-title { font-size: 18px; font-weight: 600; }
  .table-container table { width:100%; border-collapse: collapse; }
  .table-container th, .table-container td { padding:12px; border-bottom: 1px solid var(--border); text-align:left; }
  .status-badge { padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; }
  .status-badge.success { color: var(--success); border-color: rgba(16,185,129,.4); background: rgba(16,185,129,.08); }
  .status-badge.pending { color: var(--warning); border-color: rgba(245,158,11,.4); background: rgba(245,158,11,.08); }
  .chat-container { border: 1px solid var(--glass-border); border-radius: 16px; overflow:hidden; }
  .chat-messages { max-height: 60vh; overflow:auto; padding: 16px; display:flex; flex-direction:column; gap:12px; background: rgba(148,163,184,.06); }
  .chat-message { display:flex; gap:8px; }
  .chat-message.own { justify-content: flex-end; }
  .chat-bubble { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; max-width: 70ch; }
  .chat-time { color: var(--text-muted); font-size: 12px; margin-top: 6px; }
  .chat-input-area { display:flex; gap:8px; padding: 10px; background: var(--card); border-top: 1px solid var(--glass-border); }
  .chat-input { width: 100%; resize: none; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(148,163,184,.06); color: var(--text); }
  /* Modals & notifications */
  dialog { border: 1px solid var(--glass-border); border-radius: 16px; padding: 0; background: var(--card); color: var(--text); width: min(600px, 92vw); }
  .modal-header { display:flex; justify-content: space-between; align-items:center; padding: 16px; border-bottom: 1px solid var(--glass-border); }
  .modal-title { font-weight: 600; }
  .modal-content { padding: 16px; }
  .form-group { margin-bottom: 12px; }
  .form-label { display:block; margin-bottom:6px; color: var(--text-muted); font-size: 14px; }
  .form-input, .form-select, textarea.form-input { width:100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(148,163,184,.06); color: var(--text); }
  .modal-actions { display:flex; gap: 8px; justify-content:flex-end; padding: 12px 16px; border-top: 1px solid var(--glass-border); }
  #notificationContainer { position: fixed; right: 16px; bottom: 16px; display:flex; flex-direction:column; gap: 8px; z-index: 999; }
  .notification { opacity: 0; transform: translateY(6px); transition: all .3s ease; padding: 10px 12px; border-radius: 12px; background: var(--card); border: 1px solid var(--border); }
  .notification.show { opacity: 1; transform: translateY(0); }
  .sr-only { position: absolute; left: -9999px; }
  /* === Single long stage card === */
.stage-container { margin: 24px 0; }
.stage-card{
  display:flex; justify-content:space-between; align-items:center; gap:16px;
  padding:18px 20px; border:1px solid var(--glass-border); border-radius:16px;
  background: rgba(148,163,184,0.06); backdrop-filter: blur(8px);
  box-shadow: 0 8px 24px var(--shadow); transition: .2s;
}
.stage-card:hover{ background: var(--card-hover); }
.stage-left{ display:flex; align-items:center; gap:12px; }
.stage-dot{ width:12px; height:12px; border-radius:999px; background: var(--success); box-shadow:0 0 12px rgba(16,185,129,.6); }
.stage-title{ font-weight:700; color:var(--text); font-size:16px; line-height:1.2; }
.stage-sub{ color:var(--text-muted); font-size:13px; margin-top:4px; }
.stage-right{ display:flex; align-items:center; gap:8px; }

/* ซ่อนปุ่มสเต็ปเดิม */
.action-buttons .btn#btnNextStep,
.action-buttons .btn#btnBackStep,
.action-buttons .btn#btnResetSteps { display: none !important; }
.doc-summary-card { display: none !important; }

</style>
<script>
// Shared state & helpers
const STORAGE_KEY = "rgood_case_data_v2";
const DEFAULT_DATA = {
  id: "case_2025_0002",
  publicToken: "pk_XY9zL1m2",
  caseNo: "RG-AG-0002/2025",
  title: "ต่ออายุทะเบียนสารกำจัดวัชพืช",
  status: "ยื่นคำขอ",
  progressPct: 50,
  dueDate: "2025-11-15",
  product: { tradeName: "RG-Herbex 48SL", commonName: "Glyphosate isopropylamine" },
  steps: [
    { key: "receive", label: "รับเรื่อง", state: "completed", date: "2025-09-05" },
    { key: "precheck", label: "ตรวจเอกสารเบื้องต้น", state: "completed", date: "2025-09-06" },
    { key: "request_more", label: "ขอเอกสารเพิ่ม", state: "completed", date: "2025-09-08" },
    { key: "submit", label: "ยื่นคำขอ", state: "active", date: "—" },
    { key: "waiting_gov", label: "รอผลหน่วยงานรัฐ", state: "pending", date: "—" },
    { key: "approved", label: "อนุมัติแล้ว", state: "pending", date: "—" },
    { key: "close", label: "ปิดเคส", state: "pending", date: "—" }
  ],
  timeline: [
    { timestamp: "2025-09-08 12:24", text: "ลูกค้าอัปโหลดหนังสือมอบอำนาจ", type: "user" },
    { timestamp: "2025-09-06 15:11", text: "ตรวจเอกสารเบื้องต้นเสร็จ", type: "system" },
    { timestamp: "2025-09-05 09:00", text: "รับเรื่อง เปิดเลขเคส RG-AG-0002/2025", type: "system" }
  ],
  reminders: [
    { id: "r1", title: "ย้ำเอกสารตัวจริงก่อนยื่น", due: "2025-10-01", channel: "email", priority: "medium", active: true }
  ],
  chatMessages: [
    { id: "m1", sender: "staff", name: "คุณสมชาย", message: "สวัสดีครับ มีข้อสงสัยเรื่องเอกสารไหมครับ", timestamp: "2025-09-25 09:00", avatar: "👨‍💼" },
    { id: "m2", sender: "user", name: "คุณลูกค้า", message: "สวัสดีครับ อยากทราบว่าเอกสารผ่านหรือยังครับ", timestamp: "2025-09-25 09:30", avatar: "👤" }
  ],
  lineDeeplink: "https://line.me/R/ti/p/@991cyisb"
};
function loadData(){
  try { const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return structuredClone(DEFAULT_DATA);
        const parsed = JSON.parse(raw); return { ...structuredClone(DEFAULT_DATA), ...parsed }; }
  catch { return structuredClone(DEFAULT_DATA); }
}
let CASE_DATA = loadData();
const $ = (s) => document.querySelector(s);
const $$ = (s) => [...document.querySelectorAll(s)];
function showNotification(message, type='success', duration=4000){
  const container = $('#notificationContainer'); if(!container) return;
  const n = document.createElement('div'); n.className = `notification ${type}`;
  n.innerHTML = `<div style="display:flex;align-items:center;gap:12px;"><span>${type==='success'?'✅':type==='error'?'❌':'ℹ️'}</span><span>${message}</span></div>`;
  container.appendChild(n);
  setTimeout(()=>n.classList.add('show'),100);
  setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>container.removeChild(n),300); }, duration);
  const aria = $('#ariaLive'); if(aria) aria.textContent = message;
}
function persist(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(CASE_DATA)); }catch(e){ console.warn('Persist failed', e);} }
function formatDateTime(d){ const dt = new Date(d); return isNaN(dt) ? d : dt.toLocaleString('th-TH'); }
function navActive(page){
  $$('.tabs a').forEach(a => a.classList.toggle('active', a.dataset.page === page));
}
</script>
</meta></head>
<body>
<div class="container">
<header>
<div class="logo">RG</div>
<div class="header-content">
<h1>R.Good Service — พอร์ทัลลูกค้า</h1>
<div class="header-status">
<div class="status-dot"></div>
<span>ระบบออนไลน์</span>
</div>
</div>
<div class="header-actions">
<div class="last-update" id="lastUpdate">อัปเดตล่าสุด: <span id="lastUpdateText"></span></div>
<a class="btn ghost" id="btnLine">ทัก LINE</a>
<a class="btn" href="profile.html">โปรไฟล์</a>
</div>
</header>
<script>
      document.addEventListener('DOMContentLoaded', ()=>{
        const lu = document.getElementById('lastUpdateText');
        if(lu){ lu.textContent = new Date().toLocaleString('th-TH'); setInterval(()=>lu.textContent = new Date().toLocaleString('th-TH'), 60000); }
        const btnLine = document.getElementById('btnLine');
        if(btnLine){ btnLine.addEventListener('click', ()=>window.open(CASE_DATA.lineDeeplink, '_blank')); }
      });
    </script>
<nav class="tabs">
<a class="tab" data-page="dashboard" href="dashboard.html">แดชบอร์ด</a>
<a class="tab" data-page="documents" href="documents.html">เอกสาร</a>
<a class="tab" data-page="timeline" href="timeline.html">ไทม์ไลน์</a>
<a class="tab" data-page="reminders" href="reminders.html">การแจ้งเตือน</a>
<a class="tab" data-page="chat" href="chat.html">แชท</a>
</nav>
<script>document.addEventListener('DOMContentLoaded', ()=> navActive('dashboard'));</script>
<main>
<div class="case-overview">
<div class="main-case-info">
<div class="case-header">
<div class="case-title" id="caseTitle">ภาพรวมเคส: ต่ออายุทะเบียนสารกำจัดวัชพืช</div>
<div style="display:flex; gap:8px; align-items:center;">
<button class="btn tiny" id="btnEditProduct">แก้ไขชื่อการค้า/ชื่อสามัญ</button>
</div>
</div>
<div class="case-pills">
<div class="case-pill"><strong>เลขเคส:</strong> <span id="caseNo">RG-AG-0002/2025</span></div>
<div class="case-pill"><strong>สถานะ:</strong> <span id="caseStatus">ยื่นคำขอ</span></div>
<div class="case-pill"><strong>ครบกำหนด:</strong> <span id="dueDate">2025-11-15</span></div>
</div>
<div class="product-info">
<div class="info-tile">
<span class="info-label">ชื่อการค้า</span>
<span class="info-value" id="tradeName">RG-Herbex 48SL</span>
</div>
<div class="info-tile">
<span class="info-label">ชื่อสามัญ</span>
<span class="info-value" id="commonName">Glyphosate isopropylamine</span>
</div>
</div>
<div class="progress-container">
<div class="progress-header">
<div class="progress-group">
<span class="progress-label">ความคืบหน้า</span>
<strong class="progress-percentage" id="progressPct">21%</strong>
</div>
<div style="display:flex; gap:8px;">
<button class="btn tiny" id="btnAdjustProgress">ปรับเปอร์เซ็นต์</button>
<button class="btn tiny primary" id="btnCompleteAll">ตั้งเป็น 100% (ปิดเคส)</button>
</div>
</div>
<div class="progress-bar">
<div class="progress-fill" id="progressFill" style="width: 50%"></div>
</div>
</div>
<!-- Single-stage (รับเรื่อง) -->
<div class="stage-container">
  <div class="stage-card">
    <div class="stage-left">
      <div class="stage-dot"></div>
      <div>
        <div class="stage-title">รับเรื่อง</div>
        <div class="stage-sub">
          เปิดเลขเคส <strong id="stageCaseNo">RG-AG-0002/2025</strong>
          • <span id="stageDate">2025-09-05</span>
        </div>
      </div>
    </div>
    <div class="stage-right">
      <span class="status-badge success" id="stageStatus">กำลังดำเนินการ</span>
    </div>
  </div>
</div>

<div class="action-buttons" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;"><button class="btn primary" id="btnNextStep">ทำขั้นตอนถัดไป ▶</button><button class="btn" id="btnBackStep">ย้อนกลับ ◀</button><button class="btn ghost" id="btnResetSteps">รีเซ็ตขั้นตอน</button></div></div>
<div class="action-buttons">
<button class="btn primary" id="btnUpload">อัปโหลดเอกสาร</button>
<button class="btn" id="btnRequestHelp">ขอทีมช่วยต่ออายุ</button>
<button class="btn ghost" id="btnShare">แชร์ลิงก์ติดตาม</button>
</div>
</div>

</div>
</main>
</div>
<!-- Upload Document Modal -->
<dialog id="modalUpload">
<div class="modal-header">
<div class="modal-title">อัปโหลดเอกสาร</div>
<button class="btn ghost" onclick="this.closest('dialog').close()">✕</button>
</div>
<div class="modal-content">
<div class="form-group">
<label class="form-label">ชนิดเอกสาร</label>
<select class="form-select" id="docType">
<option value="id-copy">สำเนาบัตรประชาชน</option>
<option value="power-of-attorney">หนังสือมอบอำนาจ</option>
<option value="registration-doc">เอกสารสมัครทะเบียนวัตถุอันตราย</option>
<option value="company-reg">หนังสือรับรองบริษัท</option>
<option value="tax-id">ใบ ภ.พ. 20</option>
</select>
</div>
<div class="form-group">
<label class="form-label">ไฟล์เอกสาร</label>
<input accept=".pdf,.jpg,.jpeg,.png" class="form-input" id="docFile" type="file"/>
</div>
<div class="form-group">
<label class="form-label">วันหมดอายุ (ถ้ามี)</label>
<input class="form-input" id="docExpiry" type="date"/>
</div>
<div class="form-group">
<label class="form-label">หมายเหตุ</label>
<textarea class="form-input" id="docNote" placeholder="หมายเหตุเพิ่มเติม..." rows="3"></textarea>
</div>
<div class="modal-actions">
<button class="btn ghost" onclick="this.closest('dialog').close()">ยกเลิก</button>
<button class="btn primary" id="confirmUpload">อัปโหลด</button>
</div>
</div>
</dialog>
<!-- Edit Product Modal -->
<dialog id="modalProduct">
<div class="modal-header">
<div class="modal-title">แก้ไขชื่อการค้า / ชื่อสามัญ</div>
<button class="btn ghost" onclick="this.closest('dialog').close()">✕</button>
</div>
<div class="modal-content">
<div class="form-group">
<label class="form-label" for="inputTradeName">ชื่อการค้า</label>
<input class="form-input" id="inputTradeName" placeholder="เช่น RG-Herbex 48SL" type="text"/>
</div>
<div class="form-group">
<label class="form-label" for="inputCommonName">ชื่อสามัญ</label>
<input class="form-input" id="inputCommonName" placeholder="เช่น Glyphosate isopropylamine" type="text"/>
</div>
<div class="modal-actions">
<button class="btn ghost" onclick="this.closest('dialog').close()">ยกเลิก</button>
<button class="btn primary" id="confirmProduct">บันทึก</button>
</div>
</div>
</dialog>
<!-- NEW: Progress Modal -->
<dialog id="modalProgress">
<div class="modal-header">
<div class="modal-title">ปรับเปอร์เซ็นต์ความคืบหน้า</div>
<button class="btn ghost" onclick="this.closest('dialog').close()">✕</button>
</div>
<div class="modal-content">
<div class="progress-inputs" style="display:flex;flex-direction:column;gap:12px;">
<div class="range-row" style="display:flex;align-items:center;gap:12px;">
<input id="progressRange" max="100" min="0" step="5" style="flex:1;" type="range" value="50"/>
<input id="progressNumber" max="100" min="0" step="1" type="number" value="50"/>
<span>%</span>
</div>
<small style="color:var(--text-muted)">* นี่คือเปอร์เซ็นต์แสดงผลเท่านั้น หากตั้งเป็น 100% แนะนำให้ใช้ปุ่ม “ตั้งเป็น 100% (ปิดเคส)” เพื่ออัปเดตสถานะและขั้นตอนให้สอดคล้อง</small>
</div>
<div class="modal-actions">
<button class="btn ghost" onclick="this.closest('dialog').close()">ยกเลิก</button>
<button class="btn primary" id="confirmProgress">บันทึกเปอร์เซ็นต์</button>
</div>
</div>
</dialog>
<!-- Help Request Modal -->
<dialog id="modalHelp">
<div class="modal-header">
<div class="modal-title">ขอความช่วยเหลือ</div>
<button class="btn ghost" onclick="this.closest('dialog').close()">✕</button>
</div>
<div class="modal-content">
<div class="form-group">
<label class="form-label">ประเภทความช่วยเหลือ</label>
<select class="form-select" id="helpType">
<option value="renewal">ต่ออายุเอกสาร</option>
<option value="status">สอบถามสถานะ</option>
<option value="document">ปัญหาเอกสาร</option>
<option value="technical">ปัญหาเทคนิค</option>
<option value="other">อื่นๆ</option>
</select>
</div>
<div class="form-group">
<label class="form-label">รายละเอียด</label>
<textarea class="form-input" id="helpDetails" placeholder="อธิบายปัญหาหรือความต้องการ..." rows="4"></textarea>
</div>
<div class="modal-actions">
<button class="btn ghost" onclick="this.closest('dialog').close()">ยกเลิก</button>
<button class="btn primary" id="confirmHelp">ส่งคำขอ</button>
</div>
</div>
</dialog>
<div id="notificationContainer"></div>
<div aria-atomic="true" aria-live="polite" class="sr-only" id="ariaLive"></div>
<script>
function renderProgress(pct){ $('#progressPct').textContent = `${pct}%`; $('#progressFill').style.width = `${pct}%`; }
function computeProgressFromSteps(){
  const total = CASE_DATA.steps.length;
  let completed = CASE_DATA.steps.filter(s=>s.state==='completed').length;
  const hasActive = CASE_DATA.steps.some(s=>s.state==='active');
  let pct = ((completed + (hasActive?0.5:0)) / total) * 100;
  return Math.min(100, Math.round(pct));
}
function hydrate(){
  $('#tradeName').textContent = CASE_DATA.product?.tradeName || '-';
  $('#commonName').textContent = CASE_DATA.product?.commonName || '-';
  $('#caseStatus').textContent = CASE_DATA.status;
  $('#caseNo').textContent = CASE_DATA.caseNo;
  $('#dueDate').textContent = CASE_DATA.dueDate;
  renderProgress(CASE_DATA.progressPct ?? computeProgressFromSteps());
  $$('#stepper .step').forEach((el,i)=>{
    const st = CASE_DATA.steps[i]?.state || 'pending';
    el.classList.remove('completed','active');
    if(st==='completed') el.classList.add('completed');
    if(st==='active') el.classList.add('active');
    const dateEl = el.querySelector('[data-step-date]');
    if(dateEl){ dateEl.textContent = CASE_DATA.steps[i]?.date || '—'; }
  });
}
function openProductModal(){
  $('#inputTradeName').value = CASE_DATA.product?.tradeName || '';
  $('#inputCommonName').value = CASE_DATA.product?.commonName || '';
  $('#modalProduct').showModal();
}
function saveProduct(){
  const tradeName = $('#inputTradeName').value.trim();
  const commonName = $('#inputCommonName').value.trim();
  CASE_DATA.product = { tradeName: tradeName || '-', commonName: commonName || '-' };
  $('#tradeName').textContent = CASE_DATA.product.tradeName;
  $('#commonName').textContent = CASE_DATA.product.commonName;
  CASE_DATA.timeline.unshift({ timestamp: new Date().toISOString(), text: 'อัปเดตข้อมูลผลิตภัณฑ์', type: 'system' });
  persist();
  $('#modalProduct').close();
  showNotification('บันทึกชื่อการค้า/ชื่อสามัญเรียบร้อย ✅', 'success');
}
function openProgressModal(){
  const current = CASE_DATA.progressPct ?? computeProgressFromSteps();
  $('#progressRange').value = current;
  $('#progressNumber').value = current;
  $('#modalProgress').showModal();
}
function saveProgressFromModal(){
  const val = Math.max(0, Math.min(100, parseInt($('#progressNumber').value || '0', 10)));
  CASE_DATA.progressPct = val; renderProgress(val); persist(); $('#modalProgress').close();
  showNotification(`บันทึกความคืบหน้าเป็น ${val}% แล้ว`, 'success');
}
function completeAll(){
  const today = new Date().toISOString().slice(0,10);
  CASE_DATA.steps = CASE_DATA.steps.map(s=>({ ...s, state:'completed', date: s.date && s.date!=='—' ? s.date : today }));
  CASE_DATA.status = 'ปิดเคส'; CASE_DATA.progressPct = 100;
  $$('#stepper .step').forEach(el=>{ el.classList.remove('active'); el.classList.add('completed'); const d=el.querySelector('[data-step-date]'); if(d && (d.textContent==='—' || !d.textContent.trim())) d.textContent=today; });
  $('#caseStatus').textContent = CASE_DATA.status;
  renderProgress(100);
  CASE_DATA.timeline.unshift({ timestamp: new Date().toISOString(), text: 'ปิดเคส — ความคืบหน้า 100%', type: 'system' });
  persist();
  showNotification('🎉 ตั้งเป็น 100% และปิดเคสเรียบร้อย!', 'success', 5000);
}
function handleDocumentUpload(){
  const file = $('#docFile').files[0];
  const expiry = $('#docExpiry').value;
  const note = $('#docNote').value;
  if (!file) { showNotification('กรุณาเลือกไฟล์เอกสาร', 'error'); return; }
  const newDoc = { id:`d${(CASE_DATA.documents?.length||0)+1}`, type: $('#docType').selectedOptions[0].text, ref:`REF-${Math.random().toString(36).substr(2,4).toUpperCase()}`, status:'รอตรวจ', expires: expiry||'—', note: note||'อัปโหลดโดยลูกค้า' };
  (CASE_DATA.documents ||= []).push(newDoc);
  (CASE_DATA.timeline ||= []).unshift({ timestamp: new Date().toISOString(), text:`อัปโหลด${newDoc.type}แล้ว`, type:'user' });
  persist(); $('#modalUpload').close(); showNotification('อัปโหลดเอกสารสำเร็จ!', 'success');
  $('#docFile').value=''; $('#docExpiry').value=''; $('#docNote').value='';
}
function handleHelpRequest(){
  const details = $('#helpDetails').value; if(!details.trim()){ showNotification('กรุณาระบุรายละเอียด', 'error'); return; }
  (CASE_DATA.timeline ||= []).unshift({ timestamp: new Date().toISOString(), text:`ส่งคำขอความช่วยเหลือ: ${$('#helpType').selectedOptions[0].text}`, type:'user' });
  persist(); $('#modalHelp').close(); showNotification('ส่งคำขอความช่วยเหลือสำเร็จ! ทีมงานจะติดต่อกลับภายใน 24 ชั่วโมง', 'success', 6000); $('#helpDetails').value='';
}
document.addEventListener('DOMContentLoaded', ()=>{
  hydrate();
  $('#btnEditProduct').addEventListener('click', openProductModal);
  $('#confirmProduct').addEventListener('click', saveProduct);
  $('#btnAdjustProgress').addEventListener('click', openProgressModal);
  $('#confirmProgress').addEventListener('click', saveProgressFromModal);
  $('#btnCompleteAll').addEventListener('click', completeAll);
  ['btnUpload','btnNewDoc'].forEach(id=>{ const el = document.getElementById(id); if(el) el.addEventListener('click', ()=>document.getElementById('modalUpload').showModal()); });
  $('#confirmUpload').addEventListener('click', handleDocumentUpload);
  $('#btnRequestHelp').addEventListener('click', ()=>document.getElementById('modalHelp').showModal());
  $('#confirmHelp').addEventListener('click', handleHelpRequest);
  const btnShare = document.getElementById('btnShare');
  if(btnShare){ btnShare.addEventListener('click', ()=>{ const url = `${location.origin}${location.pathname.replace(/\/[^/]*$/, '')}/dashboard.html?track=${CASE_DATA.publicToken}`; navigator.clipboard.writeText(url).then(()=>showNotification('คัดลอกลิงก์ติดตามแล้ว!', 'success')); }); }
  // sync range/number
  const rng = document.getElementById('progressRange'); const num = document.getElementById('progressNumber');
  if(rng && num){ rng.addEventListener('input', e => num.value = e.target.value); num.addEventListener('input', e => rng.value = Math.max(0, Math.min(100, e.target.value||0))); }
});
</script>
<script>
// === Upgraded step flow: click-to-complete + auto progress ===
function _today(){ return new Date().toISOString().slice(0,10); }

// recompute % from steps
function _computePct(){
  const total = CASE_DATA.steps.length;
  const completed = CASE_DATA.steps.filter(s=>s.state==='completed').length;
  const hasActive = CASE_DATA.steps.some(s=>s.state==='active');
  const pct = ((completed + (hasActive?0.5:0)) / total) * 100;
  return Math.min(100, Math.round(pct));
}

// render current classes/dates from CASE_DATA
function _renderStepsFromState(){
  document.querySelectorAll('#stepper .step').forEach((el,i)=>{
    const st = CASE_DATA.steps[i]?.state || 'pending';
    el.classList.remove('completed','active');
    if(st==='completed') el.classList.add('completed');
    if(st==='active') el.classList.add('active');
    const d = el.querySelector('[data-step-date]');
    if(d){ d.textContent = CASE_DATA.steps[i]?.date || '—'; }
  });
  CASE_DATA.progressPct = _computePct();
  renderProgress(CASE_DATA.progressPct);
  document.getElementById('caseStatus').textContent = CASE_DATA.status;
}

// mark steps 0..i completed, next active
function completeUpTo(i){
  const today = _today();
  CASE_DATA.steps.forEach((s,idx)=>{
    if(idx <= i){ s.state='completed'; if(!s.date || s.date==='—') s.date=today; }
    else if(idx === i+1){ s.state='active'; if(!s.date) s.date='—'; }
    else { s.state='pending'; if(!s.date) s.date='—'; }
  });
  // update high-level status around key milestones
  const key = CASE_DATA.steps[i]?.key;
  if(key==='submit'){ CASE_DATA.status = 'ยื่นคำขอ'; }
  else if(key==='waiting_gov'){ CASE_DATA.status = 'รอผลหน่วยงานรัฐ'; }
  else if(key==='approved'){ CASE_DATA.status = 'อนุมัติแล้ว'; }
  else if(key==='close'){ CASE_DATA.status = 'ปิดเคส'; }
  else { CASE_DATA.status = CASE_DATA.steps[i+1]?.label || 'กำลังดำเนินการ'; }
  persist();
  _renderStepsFromState();
  showNotification('อัปเดตขั้นตอน: ' + (CASE_DATA.steps[i]?.label || ('ขั้นที่ '+(i+1))) + ' ✅', 'success');
}

// go to next step from current active
function nextStep(){
  const idxActive = CASE_DATA.steps.findIndex(s=>s.state==='active');
  if(idxActive === -1){
    // if nothing active, push first active or complete first
    completeUpTo(0);
  } else {
    completeUpTo(idxActive);
  }
}

// go back one step
function backStep(){
  // find last completed index
  let lastCompleted = -1;
  CASE_DATA.steps.forEach((s,i)=>{ if(s.state==='completed') lastCompleted = i; });
  const backTo = Math.max(0, lastCompleted - 1);
  CASE_DATA.steps.forEach((s,idx)=>{
    if(idx < backTo){ s.state='completed'; }
    else if(idx === backTo){ s.state='active'; }
    else { s.state='pending'; s.date = s.date || '—'; }
  });
  CASE_DATA.status = CASE_DATA.steps[backTo]?.label || 'กำลังดำเนินการ';
  persist();
  _renderStepsFromState();
  showNotification('ย้อนกลับ 1 ขั้นตอน', 'success');
}

// reset to initial flow
function resetSteps(){
  CASE_DATA.steps.forEach((s,idx)=>{
    if(idx<=2){ s.state='completed'; }
    else if(idx===3){ s.state='active'; s.date = '—'; }
    else { s.state='pending'; s.date = '—'; }
  });
  CASE_DATA.status = 'ยื่นคำขอ';
  persist();
  _renderStepsFromState();
  showNotification('รีเซ็ตขั้นตอนแล้ว', 'success');
}

// attach handlers after original hydrate()
document.addEventListener('DOMContentLoaded', ()=>{
  // step click
  document.querySelectorAll('#stepper .step').forEach((el,i)=>{
    el.style.cursor = 'pointer';
    el.addEventListener('click', ()=> completeUpTo(i));
  });
  // control buttons
  const nextBtn = document.getElementById('btnNextStep');
  const backBtn = document.getElementById('btnBackStep');
  const resetBtn = document.getElementById('btnResetSteps');
  if(nextBtn) nextBtn.addEventListener('click', nextStep);
  if(backBtn) backBtn.addEventListener('click', backStep);
  if(resetBtn) resetBtn.addEventListener('click', resetSteps);
});
</script>
<style>
/* เอฟเฟกต์ประกายบน progress + ไฮไลต์สเต็ป */
.step.flash { box-shadow: 0 0 22px rgba(59,130,246,.35); transform: translateY(-2px); }
@keyframes dotMove { from { left:-10px; } to { left: 100%; } }
.progress-fill .spark {
  position:absolute; top:-4px; width:10px; height:20px; border-radius:6px;
  background: rgba(255,255,255,.7); filter: blur(2px); animation: dotMove 2.2s linear infinite;
}
</style>

<script>
/* ===== Viewer Animation (อ่านอย่างเดียว) ===== */
(function viewerAnimation(){
  // เล่นเฉพาะฝั่งลูกค้าเท่านั้น (ถ้ามีโหมดแอดมินจะไม่เล่น)
  if (window.ROLE === 'admin') return;

  // เพิ่มประกายวิ่งบน progress bar
  const fill = document.getElementById('progressFill');
  if (fill && !fill.querySelector('.spark')) {
    const s = document.createElement('div'); s.className = 'spark'; fill.appendChild(s);
  }

  // clone state จริง เพื่อ “จำลอง” การเดินสเต็ปเท่านั้น
  const steps = (window.CASE_DATA?.steps || []).map(s => ({...s}));
  const total = steps.length;
  const realStatus = CASE_DATA.status;
  const realPct = CASE_DATA.progressPct ?? 0;

  // หาเป้าหมายสุดท้าย (ถึงสเต็ปที่ active/ล่าสุด)
  const lastCompleted = Math.max(-1, ...steps.map((s,i)=>s.state==='completed'?i:-1));
  const activeIdx = steps.findIndex(s=>s.state==='active');
  const targetIdx = activeIdx > -1 ? activeIdx : lastCompleted;

  // เริ่มแอนิเมชันจาก 0 -> targetIdx
  let i = 0;
  const delay = 650; // ms ยิ่งน้อยยิ่งเร็ว
  const ticker = setInterval(()=>{
    // อัปเดตสเต็ปบน DOM (ไม่แตะ CASE_DATA)
    document.querySelectorAll('#stepper .step').forEach((el,idx)=>{
      el.classList.remove('completed','active','flash');
      if (idx < i) el.classList.add('completed');
      if (idx === i) { el.classList.add('active','flash'); }
    });

    // บาร์คืบหน้าให้ไหลตาม
    const pct = Math.round(((i + 0.5) / total) * 100);
    document.getElementById('progressPct').textContent = pct + '%';
    document.getElementById('progressFill').style.width = pct + '%';

    if (i >= targetIdx) {
      clearInterval(ticker);
      // กลับสู่สถานะจริงของระบบให้ค่าตรงเป๊ะ
      setTimeout(()=>{
        document.querySelectorAll('#stepper .step').forEach(el=>el.classList.remove('flash'));
        if (typeof hydrate === 'function') hydrate(); // เรนเดอร์จาก CASE_DATA เดิม
        if (realPct) {
          document.getElementById('progressFill').style.width = realPct + '%';
          document.getElementById('progressPct').textContent = realPct + '%';
        }
        if (realStatus) document.getElementById('caseStatus').textContent = realStatus;
      }, 600);
    }
    i++;
  }, delay);
})();
</script>
<style>
/* เอฟเฟกต์ประกายบน progress + ไฮไลต์สเต็ป */
.step.flash { box-shadow: 0 0 22px rgba(59,130,246,.35); transform: translateY(-2px); }
@keyframes dotMove { from { left:-10px; } to { left: 100%; } }
.progress-fill .spark {
  position:absolute; top:-4px; width:10px; height:20px; border-radius:6px;
  background: rgba(255,255,255,.7); filter: blur(2px); animation: dotMove 2.2s linear infinite;
}
</style>

<script>
/* ===== Viewer Animation (อ่านอย่างเดียว) ===== */
(function viewerAnimation(){
  // เล่นเฉพาะฝั่งลูกค้าเท่านั้น (ถ้ามีโหมดแอดมินจะไม่เล่น)
  if (window.ROLE === 'admin') return;

  // เพิ่มประกายวิ่งบน progress bar
  const fill = document.getElementById('progressFill');
  if (fill && !fill.querySelector('.spark')) {
    const s = document.createElement('div'); s.className = 'spark'; fill.appendChild(s);
  }

  // clone state จริง เพื่อ “จำลอง” การเดินสเต็ปเท่านั้น
  const steps = (window.CASE_DATA?.steps || []).map(s => ({...s}));
  const total = steps.length;
  const realStatus = CASE_DATA.status;
  const realPct = CASE_DATA.progressPct ?? 0;

  // หาเป้าหมายสุดท้าย (ถึงสเต็ปที่ active/ล่าสุด)
  const lastCompleted = Math.max(-1, ...steps.map((s,i)=>s.state==='completed'?i:-1));
  const activeIdx = steps.findIndex(s=>s.state==='active');
  const targetIdx = activeIdx > -1 ? activeIdx : lastCompleted;

  // เริ่มแอนิเมชันจาก 0 -> targetIdx
  let i = 0;
  const delay = 650; // ms ยิ่งน้อยยิ่งเร็ว
  const ticker = setInterval(()=>{
    // อัปเดตสเต็ปบน DOM (ไม่แตะ CASE_DATA)
    document.querySelectorAll('#stepper .step').forEach((el,idx)=>{
      el.classList.remove('completed','active','flash');
      if (idx < i) el.classList.add('completed');
      if (idx === i) { el.classList.add('active','flash'); }
    });

    // บาร์คืบหน้าให้ไหลตาม
    const pct = Math.round(((i + 0.5) / total) * 100);
    document.getElementById('progressPct').textContent = pct + '%';
    document.getElementById('progressFill').style.width = pct + '%';

    if (i >= targetIdx) {
      clearInterval(ticker);
      // กลับสู่สถานะจริงของระบบให้ค่าตรงเป๊ะ
      setTimeout(()=>{
        document.querySelectorAll('#stepper .step').forEach(el=>el.classList.remove('flash'));
        if (typeof hydrate === 'function') hydrate(); // เรนเดอร์จาก CASE_DATA เดิม
        if (realPct) {
          document.getElementById('progressFill').style.width = realPct + '%';
          document.getElementById('progressPct').textContent = realPct + '%';
        }
        if (realStatus) document.getElementById('caseStatus').textContent = realStatus;
      }, 600);
    }
    i++;
  }, delay);
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // เลขเคส
  const caseNo = CASE_DATA.caseNo || '-';
  document.getElementById('stageCaseNo').textContent = caseNo;

  // วันที่ "รับเรื่อง" ถ้ามี ไม่งั้นใช้ timestamp แรกสุดใน timeline
  const receiveDate =
    (CASE_DATA.steps?.find(s => s.key === 'receive')?.date) ||
    (CASE_DATA.timeline?.[CASE_DATA.timeline.length - 1]?.timestamp) ||
    '—';
  document.getElementById('stageDate').textContent = receiveDate;

  // สถานะปัจจุบัน
  const st = CASE_DATA.status || 'กำลังดำเนินการ';
  const badge = document.getElementById('stageStatus');
  badge.textContent = st;
  badge.classList.remove('success','pending');
  if (/อนุมัติ|ปิดเคส/.test(st))      badge.classList.add('success');
  else if (/ขอเอกสาร|รอผล/.test(st)) badge.classList.add('pending');
});
</script>

</body>
</html>
